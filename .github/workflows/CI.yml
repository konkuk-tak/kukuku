name: CI

env:
  PROJECT: 'kukuku'

on:
  pull_request:
    branches: [ release, develop ]

jobs:
  build:
    runs-on: self-hosted
    strategy:
        matrix:
          include:
            - xcode: "14.2"
              ios: "16.2"
              simulator: "iPhone 14 Pro"

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Select Xcode ${{ matrix.xcode }}
      run: sudo xcode-select -switch /Applications/Xcode_${{ matrix.xcode}}.app && /usr/bin/xcodebuild -version

    - name: Create secret file
      env:
          DeveloperCode_SECRET: ${{ secrets.DEVELOPER_MODE_SECRET }}
      run: |
        echo $DeveloperCode_SECRET | base64 -D -o ${{ env.PROJECT }}/Developer-Code.plist
        ls -al ${{ env.PROJECT }}

    - name: Cache SwiftPM
      uses: actions/cache@v3
      with:
          path: ~/Library/Developer/Xcode/DerivedData/${{ env.PROJECT }}*/SourcePackages/
          key: ${{ runner.os }}-spm-${{ hashFiles('${{ env.PROJECT }}.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
            
    - name: Cache DerivedData
      uses: actions/cache@v3
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-iOS_derived_data-xcode_${{ matrix.xcode }}
        restore-keys: |
          ${{ runner.os }}-iOS_derived_data-
  
    - name: Build iOS ${{ matrix.ios }} on ${{ matrix.simulator }}
      env:
        XCODEPROJ: "${{ env.PROJECT }}/${{ env.PROJECT }}.xcodeproj"
      run: >
        xcodebuild build
        -project ${{ env.XCODEPROJ }}
        -scheme kukuku
        -destination 'platform=iOS Simulator,OS=${{ matrix.ios }},name=${{ matrix.simulator }}'
